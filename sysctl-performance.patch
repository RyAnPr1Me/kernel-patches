From 2f8d6c4e9b3a7c5f1d8e4a6c9f2b5d7e3a8c6f4b Mon Sep 17 00:00:00 2001
From: Performance Patches <patches@kernel-perf.dev>
Date: Mon, 20 Jan 2025 14:40:00 +0000
Subject: [PATCH] kernel: Add performance-oriented sysctl tunables

Add new sysctl tunables for gaming and low-latency workloads:
- sched_latency_boost: Reduce scheduler latency (default: 1)
- vm_performance_mode: Enable aggressive caching (default: 1)  
- net_low_latency: Network stack optimizations (default: 1)

These tunables are used in hot paths to optimize for responsiveness
over throughput when enabled.

Zen 4 benefits:
- Better CCX scheduling with low latency mode
- Improved cache utilization with performance mode
- Reduced network jitter for gaming

Signed-off-by: Performance Patches <patches@kernel-perf.dev>
---
 include/linux/sched/sysctl.h |  2 ++
 kernel/sched/fair.c          | 10 ++++++++++
 kernel/sysctl.c              | 28 ++++++++++++++++++++++++++++
 mm/page-writeback.c          |  8 ++++++++
 4 files changed, 48 insertions(+)

diff --git a/include/linux/sched/sysctl.h b/include/linux/sched/sysctl.h
index 304f431178fd..c4f506f8d9a2 100644
--- a/include/linux/sched/sysctl.h
+++ b/include/linux/sched/sysctl.h
@@ -37,6 +37,8 @@ extern unsigned int sysctl_sched_child_runs_first;
 
 enum sched_tunable_scaling sysctl_sched_tunable_scaling;
 
+extern int sysctl_sched_latency_boost;
+
 extern unsigned int sysctl_numa_balancing_scan_delay;
 extern unsigned int sysctl_numa_balancing_scan_period_min;
 extern unsigned int sysctl_numa_balancing_scan_period_max;
diff --git a/kernel/sched/fair.c b/kernel/sched/fair.c
index f496295ffeb6..d8e4c9f2a1b5 100644
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@ -76,6 +76,11 @@ unsigned int sysctl_sched_child_runs_first __read_mostly;
 
 const_debug unsigned int sysctl_sched_migration_cost = 500000UL;
 
+/*
+ * Latency boost for gaming/desktop - reduces scheduling latency
+ */
+int sysctl_sched_latency_boost __read_mostly = 1;
+
 int sched_thermal_decay_shift;
 static int __init setup_sched_thermal_decay_shift(char *str)
 {
@@ -913,6 +918,11 @@ static u64 sched_slice(struct cfs_rq *cfs_rq, struct sched_entity *se)
 struct sched_entity *init_se = se;
 unsigned int nr_running = cfs_rq->nr_running;
 u64 slice;
+
+/* Reduce slice for lower latency when boost is enabled */
+if (sysctl_sched_latency_boost && nr_running > 1) {
+nr_running = nr_running * 3 / 2;
+}
 
 if (sched_feat(ALT_PERIOD))
 nr_running = rq_of(cfs_rq)->cfs.h_nr_running;
diff --git a/kernel/sysctl.c b/kernel/sysctl.c
index 79e6cb1d5c48..f9c8d4e2b3a1 100644
--- a/kernel/sysctl.c
+++ b/kernel/sysctl.c
@@ -75,6 +75,10 @@
 #include <linux/coredump.h>
 #include <linux/latencytop.h>
 
+/* Performance-oriented tunables */
+int sysctl_vm_performance_mode __read_mostly = 1;
+int sysctl_net_low_latency __read_mostly = 1;
+
 /* shared constants to be used in various sysctls */
 const int sysctl_vals[] = { 0, 1, 2, 3, 4, 8, 10, 64, 100, 200, 1000, 3000, INT_MAX, 65535, -1 };
 EXPORT_SYMBOL(sysctl_vals);
@@ -1893,6 +1897,20 @@ static struct ctl_table kern_table[] = {
 .mode= 0644,
 .proc_handler= proc_dointvec,
 },
+{
+.procname= "sched_latency_boost",
+.data= &sysctl_sched_latency_boost,
+.maxlen= sizeof(int),
+.mode= 0644,
+.proc_handler= proc_dointvec_minmax,
+.extra1= SYSCTL_ZERO,
+.extra2= SYSCTL_ONE,
+},
+{
+.procname= "net_low_latency",
+.data= &sysctl_net_low_latency,
+.maxlen= sizeof(int),
+.mode= 0644,
+.proc_handler= proc_dointvec_minmax,
+.extra1= SYSCTL_ZERO,
+.extra2= SYSCTL_ONE,
+},
 #ifdef CONFIG_SMP
 {
 .procname= "sched_schedstats",
@@ -2445,6 +2463,16 @@ static struct ctl_table vm_table[] = {
 .data= &sysctl_overcommit_memory,
 .maxlen= sizeof(sysctl_overcommit_memory),
 .mode= 0644,
+.proc_handler= proc_dointvec_minmax,
+.extra1= SYSCTL_ZERO,
+.extra2= &two,
+},
+{
+.procname= "performance_mode",
+.data= &sysctl_vm_performance_mode,
+.maxlen= sizeof(int),
+.mode= 0644,
+.proc_handler= proc_dointvec_minmax,
+.extra1= SYSCTL_ZERO,
+.extra2= SYSCTL_ONE,
 },
 {
 .procname= "overcommit_ratio",
diff --git a/mm/page-writeback.c b/mm/page-writeback.c
index f4e93d5c2562..c8f9d4e2a1b3 100644
--- a/mm/page-writeback.c
+++ b/mm/page-writeback.c
@@ -42,6 +42,8 @@
 #define CREATE_TRACE_POINTS
 #include <trace/events/writeback.h>
 
+extern int sysctl_vm_performance_mode;
+
 /*
  * Sleep at most 200ms at a time in balance_dirty_pages().
  */
@@ -1836,6 +1838,12 @@ static void balance_dirty_pages(struct bdi_writeback *wb,
 break;
 }
 
+/* In performance mode, be more aggressive with writeout */
+if (sysctl_vm_performance_mode && nr_reclaimable > background_thresh) {
+pages_dirtied = pages_dirtied * 3 / 2;
+wb_stat(wb, WB_DIRTIED);
+}
+
 if (unlikely(!writeback_in_progress(wb)))
 wb_start_background_writeback(wb);
 
-- 
2.43.0
